#spring개념 

## 쓰레드 풀 (Thread pool)

하나의 HTTP 요청이 올때마다 쓰레드 하나씩을 생성하여 할당한다. (요청 : 쓰레드 = 1 :1)
단순히 쓰레드만 사용하게 되면 아래와 같은 문제점이 있다.

### 문제점
- 쓰레드 생성 비용이 크기 때문에 요청에 대한 응답 시간이 늘어남
- 프로세스의 처리 속도보다 빠르게 요청이 들어오면 **새로운 쓰레드가 무한으로 생성**됨
- 쓰레드가 많아질수록 **메모리를 차지**하고 **컨텍스트 스위치** 발생
- 메모리가 부족해지고 CPU 오버헤드 증가

#### 컨텍스트 스위칭?
>쓰레드 A -> 쓰레드 B -> 쓰레드 C 와 같이 작업 환경을 바꾸는 과정
>작업을 정해진 시간까지만 수행하고 다음으로 건너뜀
>이후에 다시 되돌아와서 작업 마무리

- 쓰레드를 교체하는 작업이 많아지면, 프로그램이 일하는 시간보다 교체하는 시간이 더 많아진다.

이 문제를 해결하기 위해 쓰레드를 허용 개수 내에서만 사용하도록 제한하는 쓰레드 풀을 사용한다.

![](../../images/스크린샷%202025-12-25%2020.47.58.png)

쓰레드 풀에 작업 요청이 들어오면
1. 개수가 제한된 작업 큐에 작업이 쌓인다.
2. 쓰레드 풀 안의 쓰레드들이 작업을 빼서 처리한다.

### 해결
- 정해진 양만큼의 쓰레드 사용 : 무한생성 방지
- 사용한 쓰레드는 사라지지 않고 재사용 : 쓰레드 생성 비용 절감


## 커넥션 풀 (DBCP)

Database Connection Poll


![](../../images/스크린샷%202025-12-25%2021.05.06.png)

WAS 가 실행되면서 일정량의 connection 객체를 pool 에 저장했다가, DB 작업이 필요한 클라이언트 요청이 오면 connection 객체를 빌려주고 다 쓰면 다시 반납해서 pool 에 저장한다.

### 쓰레드가 작업을 할당 받는 과정

![](../../images/스크린샷%202025-12-25%2021.06.23.png)

1. 쓰레드가 커넥션 요청
2. 커넥션 풀에서 유휴인 상태의 connection 탐색
	1. 이전에 사용했던 connection 존재 여부 확인
	2. 이전에 사용했던 connection 목록 중 사용 가능한 connection 존재 여부 확인
	3. 전체 connection 목록 중 사용 가능한 connection 존재 여부 확인
3. 쓰레드가 작업을 할당 받지 못하면 위 그림처럼
	1. HandOffQueue 를 polling 하면서 다른 쓰레드가 connection 을 반납할때까지 대기
4. connection 을 반납하면 HandOffQueue 에 반납
5. polling 하던 쓰레드는 connection 을 받고 작업 개시

### 장점

- DB 접속 객체를 미리 만들어 메모리에 저장하므로 connection 생성,삭제 작업이 없어져 빠르게 DB 에 접속 가능
- connection 수 제한으로 서버 자원 고갈 방지
- connection 재사용으로 객체 생성 비용 절감


## 유의사항

쓰레드와 커넥션 풀의 크기를 연관지어서 함께 설정해야 한다.
보통 쓰레드는 최대 200개, 커넥션 풀은 최대 10개로 설정한다.

하지만 동시 접속자가 많을 경우?
- DB 접속이 많을 경우엔 커넥션은 한정적이기 때문에 쓰레드는 커넥션이 반납될때까지 대기해야하고,
- 그렇다고 커넥션을 그만큼 늘리게 되면 유휴인 상태의 커넥션이 많아져 많은 메모리를 소요하게 된다.

그렇다고 해서 쓰레드 풀의 크기와 커넥션 풀의 크기 모두 증가하면?
- 쓰레드 증가로 인해 컨텍스트 스위칭 많이 발생
- 데이터베이스는 하드 디스크 하나당 하나의 I/O를 처리하므로 블로킹 발생

적정 쓰레드 수 : 200개
적정 커넥션 풀 수 : (코어 수 * 2) + 디스크 수

DB 병목 지점을 모니터링하며 개수를 조정하며 정하는 것이 best!


