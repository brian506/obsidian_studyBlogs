#kafka #spring 

📌 Kafka 는 Cluster -> Broker -> Topic -> Partition -> Segment 로 구성되어 있다.

![사진](../../images/kafka1.png)

___ 

# Kafka 용어 설명

### ✅ 클러스터(Cluster)

- 여러 대의 서버(브로커)로 구성된 Kafka 시스템이다.
- 메시지의 저장, 처리, 전달을 담당한다.
- 대량의 데이터를 처리하고 생산자(producer)와 소비자(consumer)에게 메시지 서비스를 제공한다.

![사진](../../images/kafka4.png)

### ✅ 브로커(Broker)

- Kafka 시스템을 구성하는 개별 서버이다.
- 외부 서버가 아닌 Kafka 서버 프로세스로 실행된다.
- 각 브로커는 Kafka Topic의 하나 이상의 Partition이 제공된다.
- 생산자로부터 데이터를 받고 소비자에게 데이터를 전달한다.
- 데이터의 안정성을 위해 파티션을 여러 브로커에 복제한다.
- 오직 하나의 브로커만이 주어진 파티션 복사본들의 리더가 될 수 있다. 그리고 Leader Brocker는 메시지를 읽고 쓰는 작업을 다루며, Follower Brocker 는 해당 데이터를 복제하여 가진다.

### ✅ 토픽(Topic)

- 메시지들의 특정 카테고리 또는 피드를 나타낸다.
- 생산자가 보내는 대상이며, 소비자가 받는 출처이다.
- 하나의 토픽을 여러 Consumer 가 구독할 수 있으며, 토픽에서 발행된 모든 메시지를 읽을 수 있다.

### ✅ 파티션(Partition)

- Topic 이 나눠지는 단위이다.
- key-value 구조(key 가 없으면 round-robin 방식)
- 파티션은 정렬되어 있지만, 쓰여지는 데이터는 키 값이 제공되지 않으면 파티션에 무작위로 할당된다.
- 각 Partition 속 메시지는 unique 한 Id 값인 offset 을 가지고 있다.


### ✅ Consumer Group 과 Consumer

Consumer 는 이벤트를 소비할 때 Polling 을 활용하여 주기적으로 소비할 이벤트가 존재하는지 확인한다.
**즉, Broker 가 소비할 주체를 정하는 게 아니라 Consumer 가 직접 결정한다.**

Consumer Group 은 해당 Topic 에 발행된 **같은 이벤트를** Consume 하는 Consumer 집단이다.
- 메시지를 어디까지 소비했는지(offset)와 메시지를 어떻게 처리할지의 로직을 정의할 수 있다.
- Partition 개수를 Consumer 보다 항상 같거나 많게 유지해야 한다.

| Partition | Consumer | 처리 방식               |
| --------- | -------- | ------------------- |
| 3         | 1        | 병렬X, 1개 처리          |
| 3         | 2        | 병렬 2개 처리,     1개 대기 |
| 3         | 3        | 병렬 3개 처리(이상적)       |
| 3         | 4        | 1개 스레드 낭비           |

___

## 📌 데이터 흐름

![[../../images/kafka2.png]]

1. Producer(생산자)가 선택한 Topic으로 데이터를 발행한다.
2. 키의 유무에 따라 __키가 없으면__ _Round-Robin_ 방식을 이용하거나, **키가 있으면** 특정 파티션에 특정 키를 가진 메시지를 보낸다.
3. Consumer(소비자)는 각 파티션에 들어온 순서대로 읽힌다.
4. **읽어들이는 파티션 순서는 정해져 있지 않고** 돌어가면서 병렬 처리된다.
5. offset 은 데이터를 읽어드린 위치를 기록한다.

___
## 비유

Kafka 를 큰 창고(데이터 저장소)라고 가정해보자.
이 창고에는 많은 **상자(Topic)** 들이 있고 각 상자는 여러 **칸(Partition)** 들로 나뉘어져 있다. 이 창고에서 데이터를 생산하는 **Producer** 가 데이터를 **상자(Topic)** 에 넣어놓고, **소비자(Consumer)** 가 필요할때 상자를 가져가서 사용한다.

이 창고를 관리하기 위해서는 **관리자**가 필요하다.
관리자는 창고 내의 상자들이 어떤 상태인지, 어디에 위치해 있는지,  어떤 소비자가 어떤 상자를 사용하는지 파악해야 한다. 이 관리자의 역할을 [[Zookeeper]] 로 비유할 수 있다.



