#project #spring #kafka #nginx 
## 📋 프로젝트 개요

**Ticket-on 프로젝트**는 티켓 예약 시스템으로, 예약부터 결제까지의 전체 프로세스를 하나의 트랜잭션으로 처리하는 구조입니다.

### 🏗️ 시스템 아키텍처

- **예약 서버 = 결제 서버** (통합 구조)
- **예약 ~ 결제**가 **하나의 트랜잭션**으로 처리
- **대기열 서버**를 통한 트래픽 제어

---

## 🚀 현재 적용된 Nginx 로드밸런싱

### 📌 적용 배경

```
예약 요청 → Nginx 로드밸런서 → 대기열 서버
```

**목적**: 예약 요청에 대한 **트래픽 분산**을 통해 서버 과부하 방지

### ⚙️ 구현 방식

- Nginx를 통해 예약 요청을 여러 대기열 서버로 분산
- 대기열 시스템을 통한 순차적 처리

---

## 🤔 핵심 고민사항: 결제 요청도 Nginx로 분산해야 할까?

### 💭 고민의 배경

> "결제 요청에 대한 부분도 Nginx를 이용해서 대기열 서버로 분산시켜줘야 하지 않나?"

---

## 🔍 두 가지 접근법 비교 분석

### 🟡 **Option 1: Nginx를 결제 요청에도 적용하는 경우**

#### ⚠️ **문제점**

- **기본 알고리즘**: Nginx의 기본 분산 방식은 **라운드 로빈**
- **세션 불일치 문제**:
    - 예약 세션을 저장한 서버 ≠ 결제를 처리할 서버
    - **메모리 기반 상태 저장**으로 인한 서버 간 정보 공유 불가

#### 🔧 **해결방안: Sticky Session**

```nginx
upstream backend {
    ip_hash;  # 클라이언트 IP 기반 서버 고정
    server server1:8080;
    server server2:8080;
    server server3:8080;
}
```

#### ❌ **Sticky Session의 한계**

|문제점|설명|
|---|---|
|**트래픽 편중**|특정 서버에 사용자가 몰릴 수 있음|
|**단일 장애점**|해당 서버 장애 시 세션 정보 완전 손실|
|**확장성 제약**|서버 추가/제거 시 세션 재분배 어려움|

---

### 🟢 **Option 2: Nginx를 결제 요청에 적용하지 않는 경우**

#### ✅ **장점 분석**

##### 1. **트래픽 특성**

```
전체 사용자 → 대기열 필터링 → 예약 완료 사용자 → 결제 요청
     ↓              ↓              ↓              ↓
   대용량          중간량          소량           소량
```

- **예약 완료 사용자는 제한적**: 대기열을 통과한 **필터링된 사용자**
- **결제 요청 부하는 예약 요청 대비 현저히 낮음**

##### 2. **Kafka의 고성능 처리 능력**

|성능 지표|수치|
|---|---|
|**처리량**|초당 **수천~수만 건** 메시지 처리|
|**지연시간**|**매우 낮은** write 지연률|
|**I/O 방식**|**연속 쓰기 기반** Disk I/O|

##### 3. **아키텍처 단순성**

- 복잡한 세션 관리 불필요
- 서버 간 상태 동기화 문제 해결
- 장애 복구 시나리오 단순화

---

## 📊 최종 권장사항

### 🎯 **결론: Option 2 선택 권장**

#### 🏆 **선택 이유**

1. **트래픽 패턴 최적화**: 대기열 시스템으로 이미 트래픽이 제어됨
2. **기술적 복잡성 감소**: Sticky Session으로 인한 부작용 회피
3. **시스템 안정성**: 단순한 구조로 장애 포인트 최소화
4. **성능 충분성**: Kafka의 고성능으로 결제 트래픽 처리 가능

#### 🔄 **최적화된 아키텍처**

```
예약 요청 → Nginx → 대기열 서버 → 예약 처리
                         ↓
결제 요청 ────────────→ Kafka → 결제 처리
```

---

## 📈 성능 모니터링 포인트

### 🎯 **주요 메트릭**

- **대기열 처리량**: 초당 예약 요청 처리 건수
- **결제 응답시간**: Kafka를 통한 결제 처리 지연시간
- **서버 리소스**: CPU, 메모리 사용률 모니터링
- **에러율**: 예약-결제 트랜잭션 실패율

### 🚨 **임계점 설정**

- 결제 요청이 **예상치를 초과**하는 경우에만 Nginx 분산 고려
- **모니터링 기반**의 점진적 아키텍처 개선

---

## 🔗 관련 문서

- [[로드밸런서]]
- [[Kafka 성능 최적화]]
