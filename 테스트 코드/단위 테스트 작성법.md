#테스트코드

단위테스트는 통합테스트와 달리 @Mock 을 이용하여 DB,Network 을 가짜로 대체하고 비즈니스 로직만을 검증한다.
다른 서비스로의 호출은 실제로 하지 않고 가짜로 처리하여 비즈니스 로직이 성공적으로 이루어졌는지 검증한다.

repository,외부 서비스 - @Mock
service - @InjectMocks (테스트 대상 Service)

`given()`  : @Mock 처리하는 클래스일 때 사용 
	- 예) A 라고 했을 때 B 라고 출력해!


## 회원가입 단위 테스트 작성 예시

### UserService

```java
@Transactional  
public SignUpUserResponse createUserInfo(final CreateUserRequest userRequest){  
  
    // Auth-service 로 email,password 가입 요청  
    AuthRegisterRequest registerRequest = AuthRegisterRequest.toCreateUser(userRequest);  
    AuthRegisterResponse registerResponse = authService.registerUser(registerRequest);  
  
    if(!validateEmail(userRequest.email())){  
        throw new ConflictException("이미 사용 중인 이메일입니다.");  
    }  
  
    if (!validateNickname(userRequest.nickname())) {  
        throw new ConflictException("이미 사용 중인 닉네임입니다.");  
    }  
  
    User user = User.signUpDtoToEntity(userRequest,registerResponse.userId());  
    userRepository.save(user);  
  
    return SignUpUserResponse.requestToResponse(userRequest, registerResponse.userId());  
}
```

**테스트 목적** 
1. Auth-service 로 email,password 가입 요청 - 외부호출
2. 이메일,닉네임 중복 검증
3. `UserRepository`에 잘 반영됐는지 검증

위와 같은 로직을 테스트 코드로 나타내보자

```java
@Test  
@DisplayName("회원가입 성공 테스트")  
void createUserInfo_SUCCESS() throws Exception {  
    //given  
    CreateUserRequest userRequest = new CreateUserRequest("test@email.com", "password", "영민짱", LocalDate.of(2000, 05, 06), Gender.MALE);  
    given(authServiceClient.registerUser(any(AuthRegisterRequest.class))) // 외부 호출 mock 처리  
            .willReturn(new AuthRegisterResponse("1234", "test@email.com", "영민짱"));  
  
    given(userRepository.existsByEmail("test@email.com")).willReturn(false); // false 일 때 통과  
    given(userRepository.existsByNickname("영민짱")).willReturn(false);  
  
    //when  
    userService.createUserInfo(userRequest);  
    //then  
    verify(userRepository).save(argThat(user ->  
                    user.getNickname().equals("영민짱") &&  
                    user.getGender() == Gender.MALE &&  
                    user.getId().equals("1234")  
    ));  
}
```
#### given
1. **요청DTO 생성** : 회원가입 요청 DTO 객체를 임의로 생성
2. **외부 호출 응답** : `given()` 으로 `any()` 를 이용하여 아무 요청 DTO 로 auth-service 로 호출해서 내가 정한 `AuthResponse`로 응답DTO 반환 지정
3. **중복 검증 지정** : `given()` 으로 내가 만든 email,nickname 이 중복되지 않은 값으로 지정 

#### when
1. **UserService 호출** : UserService 내의 `.save()`를 Mockito 가 가로채서 Mock 내의 repository 메모리에 저장

#### then 
1. **파라미터 값 동일 여부 검증** : UserService 로직 이후에 저장된 repository 에 기반해서 파라미터 값이 같은지 검증